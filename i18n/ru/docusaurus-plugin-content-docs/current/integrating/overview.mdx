---
sidebar_label: Обзор
sidebar_position: 0
---

# Обзор интеграции

<AppliesTo all />

Чтобы интегрировать Velopack в ваше приложение, вы _должны_ инициализировать Velopack как можно раньше при запуске приложения и _должны_ добавить куда-нибудь код проверки обновлений.

Для приложений .NET сначала следует установить [Пакет Velopack Nuget](https://nuget.org/packages/velopack).

## Запуск приложения

Velopack требует, чтобы вы добавили некоторый код при запуске приложения для обработки перехватчиков. Это связано с тем, что Velopack будет запускать ваш основной двоичный файл на определенных этапах процесса установки/обновления со специальными аргументами, чтобы вы могли настроить поведение. Он ожидает, что ваше приложение правильно отреагирует на эти аргументы и завершится как можно скорее. 

Самый простой/минимальный способ справиться с этим должным образом — добавить код запуска SDK в ваш метод Main(). Он должен находиться в «основном» двоичном файле (тот, который указан при упаковке с помощью `--mainExe {exeName}`).

```cs
static void Main(string[] args)
{
    VelopackApp.Build().Run();
    // ... ваш другой код запуска ниже
}
```

Здесь вы можете указать множество опций/обратных вызовов для настройки Velopack, например:

```cs
static void Main(string[] args)
{
    ILogger log = CreateLogger();
    VelopackApp.Build()
        .WithBeforeUninstallFastCallback((v) => {
            // delete / clean up some files before uninstallation
        })
        .WithFirstRun((v) => {
            MessageBox.Show("Thanks for installing my application!");
        })
        .Run(log);
}
```

Полный список опций [для VelopackApp доступен здесь](../reference/cs//Velopack/VelopackApp.md). Вы также можете узнать больше о [как работают хуки] \(./hooks.mdx).

:::warning
«FastCallback» требует, чтобы ваше приложение не отображало пользовательский интерфейс и быстро закрывалось. Когда обратный вызов вернется, ваше приложение завершится. Если вы не завершите этот обратный вызов достаточно быстро, ваш процесс будет завершен.
:::

## Настройка обновлений

Обновления можно выполнить, добавив [UpdateManager](../reference/cs/Velopack/UpdateManager.md) в ваше приложение:

```cs
частная статическая асинхронная задача UpdateMyApp()
{
    var mgr = new UpdateManager("https://the.place/you-host/updates");

    // проверка наличия новой версии
    var newVersion = await mgr.CheckForUpdatesAsync();
    if (newVersion == null)
        return; // обновление отсутствует

    // загрузка новой версии
    await mgr.DownloadUpdatesAsync(newVersion);

    // устанавливаем новую версию и перезапускаем приложение
    mgr.ApplyUpdatesAndRestart(newVersion);
}
```

:::tip
Обновления могут выполняться автоматически в фоновом режиме или интегрироваться в пользовательский интерфейс вашего приложения. Это всегда зависит от вас.
:::

Вы можете размещать пакеты обновлений где угодно, вот несколько примеров:

- Локальный каталог:<br/>`new UpdateManager("C:\Updates")`
- HTTP-сервер или S3, хранилище Azure и т. д.:<br/>`new UpdateManager("https://the.place/you-host/updates")`
- Релизы GitHub:<br/>`new UpdateManager(new GitHubSource("https://github.com/yourName/yourRepo")`

Существует множество встроенных источников (например, [GithubSource](../reference/cs/Velopack.Sources/GithubSource.md), [SimpleWebSource](../reference/cs/Velopack.Sources/SimpleWebSource.md). )) вы можете использовать при проверке обновлений, но вы также можете создать свои собственные, [на основе IUpdateSource](../reference/cs/Velopack.Sources/IUpdateSource.md).

### Проверьте наличие обновлений

CheckForUpdatesAsync прочитает предоставленный источник обновлений для файла Releases.{channel}.json\` файл для получения доступных обновлений ([Читать о каналах](../packaging/channels.mdx)). Если доступно обновление, будет возвращен непустой [UpdateInfo](../reference/cs/Velopack/UpdateInfo.md) с некоторыми подробностями об обновлении. Вы также можете [получить любые примечания к выпуску](release-notes.mdx), которые были предоставлены при упаковке обновления.

Существуют [также некоторые параметры](../reference/cs/Velopack/UpdateOptions.md), которые можно передать в [UpdateManager](../reference/cs/Velopack/UpdateManager.md), чтобы настроить обработку обновлений. , напр. чтобы разрешить такие вещи, как [переключение каналов](switching-channels.mdx).

### Загрузка обновлений

DownloadUpdatesAsync попытается загрузить изменения (если они доступны) и воссоздать последнюю полную версию. Если доступных изменений нет или дельта-реконструкция не удалась, вместо этого будет загружен последний полный пакет выпуска. Обратите внимание: если указана такая опция, как «AllowVersionDowngrade», загруженная версия может быть старше, чем выполняющаяся в данный момент версия.

### Применить обновления

После загрузки обновления у вас появится несколько доступных вариантов. Вызов «ApplyUpdatesAndRestart» или «ApplyUpdatesAndExit» приведет к выходу из вашего приложения, установке всех [предварительных требований для начальной загрузки] \(../packaging/bootstrapping.mdx), установке обновления, а затем, при необходимости, сразу же перезапустите приложение.

Если вы не хотите немедленно выходить из приложения, вы можете вместо этого вызвать WaitExitThenApplyUpdates, который запустит Update.exe и подождет 60 секунд, прежде чем продолжить. Если ваше приложение не закроется в течение 60 секунд, оно будет закрыто.

Наконец, если вы не вызываете ни один из этих методов «Применить», то при перезапуске приложения Velopack по умолчанию обнаружит наличие ожидающего обновления и установит его. Если вы хотите отключить это, вам следует вызвать `VelopackApp.Build().SetAutoApplyOnStartup(false)`.

:::tip
Рекомендуется использовать одну из функций, которая явно применяет пакет (например, «ApplyUpdatesAndRestart»), и не полагаться на поведение AutoApply как на практическое правило. Автоматическое поведение будет применять только загруженную версию, если она> установленной в данный момент версии, поэтому не будет работать при попытке понизить версию или переключить каналы, и если запущено более одного экземпляра вашего процесса, это может привести к сбою обновления или другие процессы завершаются.
:::

## Как работают обновления

### В Windows

При типичной установке Windows структура приложения будет выглядеть следующим образом:

```
%LocalAppData%
└── {packId}
    ├── текущий
    │ ├── YourFile.dll
    │ ├── sq. версия
    │ └── YourApp.exe
    └── Update.exe
```

`sq.version` — это специальный файл, созданный Velopack, который содержит некоторые метаданные об установленном вами в данный момент приложении. Во время установки/удаления вся папка `{packId}` заменяется или удаляется. Во время обновлений заменяется только текущая папка. Если вы сохраните настройки в той же папке, что и основной двоичный файл, они будут удалены во время обновлений. 

:::warning
Поскольку «текущая» версия заменяется новой версией во время обновлений, хранить настройки, журналы и т. д. в «текущем» каталоге, где находится ваше приложение, небезопасно. Дополнительную информацию см. в разделе **_[Сохранение файлов](./preserved-files.mdx)_**.
:::

### В Linux и Mac

На этих платформах приложение хранится как один пакет (обычно доступный только для чтения), например `.app` или `.AppImage`. Пакет заменяется во время обновлений одной атомарной операцией.
Если у вас есть какие-либо файлы, которые вы хотите сохранить (настройки, журналы и т. д.), вам необходимо найти каталог в другом месте файловой системы для хранения этих файлов.
