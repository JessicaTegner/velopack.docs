# Действия GitHub

<AppliesTo all />

В этом разделе предполагается, что у вас есть базовые знания о действиях GitHub. Вы можете узнать больше о
создании рабочих процессов [здесь](https://docs.github.com/en/actions/deployment/about-deployments/deploying-with-github-actions).

### Создание рабочего процесса

В следующем примере предполагается, что вы создаете приложение для Windows, но вы можете адаптировать рабочий процесс и для других платформ.

Сначала создайте рабочий процесс в своем репозитории по адресу `.github/workflows` с расширением `.yml`, например
`.github/workflows/main.yml`. Этот пример рабочего процесса будет запущен, когда код будет отправлен в ветку `main`. Если вы предпочитаете другой триггер, обратитесь к документации
, указанной выше.

```yml
имя: Развертывание в выпусках GitHub

on:
  push:
    ветки:
      - main
```

Создайте задание, которое будет запускаться при активации триггера. Этот пример будет работать на машине с `windows-latest`, поскольку мы
упаковываем для Windows.

```yml
задания:
  развертывание-на-GitHub-релизы:
    запуск: Windows-последние
    шаги:
```

### Компиляция приложения

Сначала добавьте шаг по извлечению вашего репозитория, чтобы получить все файлы, необходимые для компиляции вашего приложения.

```yml
      - имя: Репозиторий Checkout
        использует: action/checkout@v4
```

Для упаковки с помощью Velopack вам понадобится номер версии вашего релиза. Есть много способов справиться с этим.
Если для этого вы используете переменные действий GitHub, вы можете пропустить этот шаг. В этом примере номер версии
будет извлечен из тега `<Version>` в `.csproj` приложения. Оболочка `bash` определена здесь
, так как в противном случае эта команда завершится ошибкой при запуске в Windows. The command works by using a regular expression
with `grep` to extract the value between `<Version>` and `</Version>` in the csproj file, and store it in a
variable called `version` in the current run of the workflow.

```yml
      - имя: Получить версию из файла проекта
        id: get-version
        оболочка: bash
        запустить: echo "version=$(grep -oE '<Version>[^ <]+' MyApplication/MyApplication.csproj | sed 's/<Version>//')" >> $GITHUB_OUTPUT
```

Затем добавьте шаг по установке .NET, чтобы приложение можно было скомпилировать. Установите `dotnet-version` на версию, необходимую
вашему приложению.

```yml
      - имя: Install .NET
        использует: action/setup-dotnet@v4
        с:
          версия dotnet: 8.0.x
```

Скомпилируйте ваше приложение. В этом примере это будет сделано путем публикации приложения в папке автономным образом.
Вы можете публиковать без флага автономности, если используете Velopack для установки таких зависимостей
(подробности см. в разделе [Загрузка](../packaging/bootstrapping.mdx). This command uses the `-c` flag to set the build
configuration to `Release` mode, `-o` to set the output directory to `publish`, `-r` to set the runtime
to `win-x64` for distributing on 64-bit Windows, and `--self-contained` to publish the .NET runtime with the
application. Адаптируйте эту команду к своим потребностям. Дополнительную информацию о
`dotnetPublish` можно узнать в [Документации Microsoft](https://learn.microsoft.com/dotnet/core/tools/dotnet-publish).

```yml
      - имя: Опубликовать приложение
        запустить: dotnetPublish MyProject/MyProject.csproj -c Release -oPublish -r win-x64 --self-contained true
```

### Развертывание релиза

Наконец, используйте Velopack для упаковки вашего приложения и развертывания выпуска. Создайте шаг, который запускает несколько команд
в командной строке.

Давайте разберем, что делает каждая строка.

1. Устанавливает интерфейс командной строки Velopack.
2. Загружает последнюю версию вашего репозитория. Это необходимо для того, чтобы Velopack мог создать дельта-пакет
   между текущим выпуском и новым, а также заполнить файлы выпусков.
3. Вызывает интерфейс командной строки Velopack для упаковки вашего приложения. Аргумент `-v` вызывает
   назначенную ранее переменную `version`, доступ к которой осуществляется с использованием `id` шага, который ее назначил (`get-version`).
   `-p` указывает на каталог `publish`, который использовался на предыдущем шаге. Для получения дополнительной информации о интерфейсе командной строки Velopack
   и о том, какие флаги доступны для команды `pack`, [см. здесь](../packaging/overview.mdx).
4. Создает новый релиз в вашем репозитории и автоматически загружает в него необходимые файлы.

:::tip
Если ваш репозиторий является частным, вам необходимо будет предоставить Velopack токен OAuth при использовании команд `vpk download`
и `vpk upload`. Просто добавьте к обеим командам следующее: `--token ${{ secrets.GITHUB_TOKEN }}`.
:::

```yml
      - name: Create Velopack Release
        run: |
          dotnet tool install -g vpk
          vpk download github --repoUrl https://github.com/Myname/Myrepo
          vpk pack -u MyUniqueIdentifier -v ${{ steps.get-version.outputs.version }} -p publish
          vpk upload github --repoUrl https://github.com/Myname/Myrepo --publish --releaseName "MyProject ${{ steps.get-version.outputs.version }}" --tag v${{ steps.get-version.outputs.version }}
```
